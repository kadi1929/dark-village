const express = require('express');
const http = require('http');
const socketIo = require('socket.io');
const path = require('path');
const cors = require('cors');

const app = express();
const server = http.createServer(app);

const io = socketIo(server, {
  cors: {
    origin: "*",
    methods: ["GET", "POST"]
  }
});

app.use(cors());
app.use(express.json());
app.use(express.static(path.join(__dirname, 'client')));

// ุชุฎุฒูู ุงูุจูุงูุงุช
const rooms = new Map();
const players = new Map();

// ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ
app.get('/', (req, res) => {
  res.sendFile(path.join(__dirname, 'client', 'index.html'));
});

// ุงุฎุชุจุงุฑ ุงูุฎุงุฏู
app.get('/test', (req, res) => {
  res.json({ 
    status: 'โ ุงูุฎุงุฏู ุดุบุงู',
    rooms: rooms.size,
    players: players.size
  });
});

// ุฃุญุฏุงุซ Socket.io
io.on('connection', (socket) => {
  console.log('๐ ูุงุนุจ ูุชุตู:', socket.id);

  // ุฅูุดุงุก ุบุฑูุฉ
  socket.on('create-room', (data) => {
    console.log('๐ฎ ุทูุจ ุฅูุดุงุก ุบุฑูุฉ:', data);
    
    const { roomCode, roomName, playerName } = data;
    
    if (!roomCode || !roomName || !playerName) {
      socket.emit('create-error', 'ุฌููุน ุงูุญููู ูุทููุจุฉ');
      return;
    }

    if (rooms.has(roomCode)) {
      socket.emit('create-error', 'ุฑูู ุงูุบุฑูุฉ ููุฌูุฏ ูุณุจูุงู');
      return;
    }

    // ุฅูุดุงุก ุบุฑูุฉ ุฌุฏูุฏุฉ
    const room = {
      name: roomName,
      code: roomCode,
      players: [],
      maxPlayers: 10,
      gameState: 'waiting',
      createdAt: new Date()
    };

    rooms.set(roomCode, room);
    
    // ุฅูุดุงุก ูุงุนุจ ูุดุฑู
    const gameMaster = {
      id: socket.id,
      name: playerName,
      isGameMaster: true,
      role: null,
      isAlive: true,
      socketId: socket.id
    };

    room.players.push(gameMaster);
    players.set(socket.id, { roomCode, player: gameMaster });

    // ุงูุงูุถูุงู ููุบุฑูุฉ
    socket.join(roomCode);
    
    // ุฅุฑุณุงู ุงูุงุณุชุฌุงุจุงุช
    socket.emit('room-created', {
      roomCode: roomCode,
      roomName: roomName,
      message: 'ุชู ุฅูุดุงุก ุงูุบุฑูุฉ ุจูุฌุงุญ!'
    });

    socket.emit('join-success', room);
    
    console.log(`โ ${playerName} ุฃูุดุฃ ุบุฑูุฉ ${roomCode}`);
  });

  // ุงูุงูุถูุงู ุฅูู ุบุฑูุฉ
  socket.on('join-room', (data) => {
    console.log('๐ ุทูุจ ุงูุถูุงู:', data);
    
    const { roomCode, playerName, isGameMaster } = data;
    
    if (!roomCode || !playerName) {
      socket.emit('join-error', 'ุฑูู ุงูุบุฑูุฉ ูุงุณู ุงููุงุนุจ ูุทููุจุงู');
      return;
    }

    const room = rooms.get(roomCode);
    if (!room) {
      socket.emit('join-error', 'ุงูุบุฑูุฉ ุบูุฑ ููุฌูุฏุฉ');
      return;
    }

    if (room.players.length >= room.maxPlayers) {
      socket.emit('join-error', 'ุงูุบุฑูุฉ ููุชูุฆุฉ');
      return;
    }

    const existingPlayer = room.players.find(p => p.name === playerName);
    if (existingPlayer) {
      socket.emit('join-error', 'ุงุณู ุงููุงุนุจ ููุฌูุฏ ูุณุจูุงู');
      return;
    }

    // ุฅูุดุงุก ูุงุนุจ ุฌุฏูุฏ
    const player = {
      id: socket.id,
      name: playerName,
      isGameMaster: isGameMaster || false,
      role: null,
      isAlive: true,
      socketId: socket.id,
      joinedAt: new Date()
    };

    room.players.push(player);
    players.set(socket.id, { roomCode, player });

    socket.join(roomCode);
    
    // ุฅุฑุณุงู ุงูุชุญุฏูุซุงุช
    io.to(roomCode).emit('room-updated', room);
    io.to(roomCode).emit('player-joined', { 
      playerName, 
      playersCount: room.players.length 
    });

    socket.emit('join-success', room);

    console.log(`โ ${playerName} ุงูุถู ุฅูู ุบุฑูุฉ ${roomCode}`);
  });

  // ุชูุฒูุน ุงูุฃุฏูุงุฑ
  socket.on('assign-roles', (data) => {
    const { roomCode } = data;
    const room = rooms.get(roomCode);
    
    if (!room) {
      socket.emit('roles-error', 'ุงูุบุฑูุฉ ุบูุฑ ููุฌูุฏุฉ');
      return;
    }

    // ุฃุฏูุงุฑ ูุจุณุทุฉ ููุชุฌุฑุจุฉ
    const availableRoles = [
      { id: 'werewolf_alpha', name: 'ุงูุฐุฆุจ ุฃููุง', emoji: '๐ค' },
      { id: 'seer', name: 'ุงูุนุฑุงูุฉ', emoji: '๐ฎ' },
      { id: 'witch', name: 'ุงูุณุงุญุฑุฉ', emoji: '๐งช' },
      { id: 'guardian', name: 'ุงูุถุงูู', emoji: '๐' },
      { id: 'hunter', name: 'ุงูุตูุงุฏ', emoji: '๐' },
      { id: 'villager', name: 'ูุฑูู', emoji: '๐จโ๐พ' },
      { id: 'villager', name: 'ูุฑูู', emoji: '๐จโ๐พ' }
    ];

    // ุชูุฒูุน ุนุดูุงุฆู
    const shuffledPlayers = [...room.players].sort(() => Math.random() - 0.5);
    const shuffledRoles = [...availableRoles].sort(() => Math.random() - 0.5);

    shuffledPlayers.forEach((player, index) => {
      if (index < shuffledRoles.length) {
        player.role = shuffledRoles[index];
      }
    });

    room.rolesAssigned = true;
    
    io.to(roomCode).emit('roles-assigned', room);
    io.to(roomCode).emit('notification', {
      type: 'success',
      message: 'ุชู ุชูุฒูุน ุงูุฃุฏูุงุฑ ุจูุฌุงุญ!'
    });

    console.log(`โ ุชู ุชูุฒูุน ุงูุฃุฏูุงุฑ ูู ุบุฑูุฉ ${roomCode}`);
  });

  // ุจุฏุก ุงููุนุจุฉ
  socket.on('start-game', (roomCode) => {
    const room = rooms.get(roomCode);
    if (room) {
      room.gameState = 'playing';
      io.to(roomCode).emit('notification', {
        type: 'success',
        message: 'ุจุฏุฃุช ุงููุนุจุฉ!'
      });
      console.log(`๐ฎ ุจุฏุฃุช ุงููุนุจุฉ ูู ุบุฑูุฉ ${roomCode}`);
    }
  });

  // ูุบุงุฏุฑุฉ ุงูุบุฑูุฉ
  socket.on('leave-room', (data) => {
    const { roomCode, playerName } = data;
    const room = rooms.get(roomCode);
    
    if (room) {
      room.players = room.players.filter(p => p.name !== playerName);
      players.delete(socket.id);
      
      io.to(roomCode).emit('player-left', { 
        playerName, 
        playersCount: room.players.length 
      });
      io.to(roomCode).emit('room-updated', room);
      
      if (room.players.length === 0) {
        rooms.delete(roomCode);
        console.log(`๐๏ธ ุชู ุญุฐู ุงูุบุฑูุฉ ${roomCode}`);
      }
    }

    socket.leave(roomCode);
    console.log(`๐ ${playerName} ุบุงุฏุฑ ุงูุบุฑูุฉ ${roomCode}`);
  });

  // ูุตู ุงูุงุชุตุงู
  socket.on('disconnect', () => {
    console.log('โ ูุงุนุจ ููุตูู:', socket.id);
  });
});

const PORT = process.env.PORT || 3000;
server.listen(PORT, '0.0.0.0', () => {
  console.log('๐ ุฎุงุฏู ุงููุฑูุฉ ุงููุธููุฉ ุดุบุงู ุนูู http://localhost:' + PORT);
});
server.listen(PORT, () => {
  console.log(`๐ฏ ุงูุฎุงุฏู ุดุบุงู ุนูู ุงููููุฐ ${PORT}`);
  console.log(`๐ http://localhost:${PORT}`);
  console.log(`๐ ุฑุงุจุท ุงููุงุฌูุฉ: http://localhost:${PORT}/client`);
});
