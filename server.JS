const express = require('express');
const http = require('http');
const socketIo = require('socket.io');
const path = require('path');
const cors = require('cors');

const app = express();
const server = http.createServer(app);
const io = socketIo(server, {
  cors: {
    origin: "*",
    methods: ["GET", "POST"]
  }
});

// ุชุฎุฒูู ุงูุจูุงูุงุช ูู ุงูุฐุงูุฑุฉ (ูู production ุงุณุชุฎุฏู ูุงุนุฏุฉ ุจูุงูุงุช)
const rooms = new Map();
const players = new Map();

// Middleware
app.use(cors());
app.use(express.json());
app.use(express.static(path.join(__dirname, '../client')));

// ูุณุงุฑ ููุชุญูู ูู ุฃู ุงูุฎุงุฏู ุดุบุงู
app.get('/health', (req, res) => {
  res.json({ status: 'OK', message: 'ุงูุฎุงุฏู ุดุบุงู ๐' });
});

// ุงูุญุตูู ุนูู ูุนูููุงุช ุงูุบุฑูุฉ
app.get('/room/:code', (req, res) => {
  const room = rooms.get(req.params.code);
  if (room) {
    res.json(room);
  } else {
    res.status(404).json({ error: 'ุงูุบุฑูุฉ ุบูุฑ ููุฌูุฏุฉ' });
  }
});

// ุฃุญุฏุงุซ Socket.io
io.on('connection', (socket) => {
  console.log('๐ฅ ูุงุนุจ ูุชุตู:', socket.id);

  // ุงูุถูุงู ูุงุนุจ ุฅูู ุบุฑูุฉ
  socket.on('join-room', async (data) => {
    const { roomCode, playerName, isGameMaster } = data;
    
    try {
      // ุงูุจุญุซ ุนู ุงูุบุฑูุฉ ุฃู ุฅูุดุงุคูุง
      if (!rooms.has(roomCode)) {
        rooms.set(roomCode, {
          name: `ุบุฑูุฉ ${roomCode}`,
          code: roomCode,
          players: [],
          maxPlayers: 10,
          gameState: 'waiting', // waiting, playing, finished
          rolesAssigned: false,
          createdAt: new Date()
        });
      }

      const room = rooms.get(roomCode);
      
      // ุงูุชุญูู ูู ุนุฏู ุชูุฑุงุฑ ุงูุงุณู
      const existingPlayer = room.players.find(p => p.name === playerName);
      if (existingPlayer) {
        socket.emit('join-error', 'ุงุณู ุงููุงุนุจ ููุฌูุฏ ูุณุจูุงู ูู ูุฐู ุงูุบุฑูุฉ');
        return;
      }

      // ุงูุชุญูู ูู ุนุฏุฏ ุงููุงุนุจูู
      if (room.players.length >= room.maxPlayers) {
        socket.emit('join-error', 'ุงูุบุฑูุฉ ููุชูุฆุฉ');
        return;
      }

      // ุฅูุดุงุก ูุงุนุจ ุฌุฏูุฏ
      const player = {
        id: socket.id,
        name: playerName,
        isGameMaster: isGameMaster || false,
        role: null,
        isAlive: true,
        socketId: socket.id,
        joinedAt: new Date()
      };

      // ุฅุถุงูุฉ ุงููุงุนุจ ููุบุฑูุฉ
      room.players.push(player);
      players.set(socket.id, { roomCode, player });

      // ุงูุถูุงู Socket ููุบุฑูุฉ
      socket.join(roomCode);
      
      // ุฅุฑุณุงู ุชุญุฏูุซ ููุฌููุน ูู ุงูุบุฑูุฉ
      io.to(roomCode).emit('room-updated', room);
      io.to(roomCode).emit('player-joined', { 
        playerName, 
        playersCount: room.players.length 
      });

      // ุฅุฑุณุงู ูุฌุงุญ ุงูุงุชุตุงู ููุงุนุจ ุงูุฌุฏูุฏ
      socket.emit('join-success', room);

      console.log(`๐ฎ ${playerName} ุงูุถู ุฅูู ุบุฑูุฉ ${roomCode}`);

    } catch (error) {
      console.error('โ ุฎุทุฃ ูู ุงูุงูุถูุงู ููุบุฑูุฉ:', error);
      socket.emit('join-error', 'ุญุฏุซ ุฎุทุฃ ูู ุงูุงูุถูุงู ููุบุฑูุฉ');
    }
  });

  // ุฅูุดุงุก ุบุฑูุฉ ุฌุฏูุฏุฉ
  socket.on('create-room', (data) => {
    const { roomCode, roomName, playerName } = data;
    
    try {
      if (rooms.has(roomCode)) {
        socket.emit('create-error', 'ุฑูู ุงูุบุฑูุฉ ููุฌูุฏ ูุณุจูุงู');
        return;
      }

      // ุฅูุดุงุก ุบุฑูุฉ ุฌุฏูุฏุฉ
      const room = {
        name: roomName,
        code: roomCode,
        players: [],
        maxPlayers: 10,
        gameState: 'waiting',
        rolesAssigned: false,
        createdAt: new Date()
      };

      rooms.set(roomCode, room);
      socket.emit('room-created', { roomCode, roomName });

      console.log(`๐ ุชู ุฅูุดุงุก ุบุฑูุฉ ${roomCode}: ${roomName}`);

    } catch (error) {
      console.error('โ ุฎุทุฃ ูู ุฅูุดุงุก ุงูุบุฑูุฉ:', error);
      socket.emit('create-error', 'ุญุฏุซ ุฎุทุฃ ูู ุฅูุดุงุก ุงูุบุฑูุฉ');
    }
  });

  // ุชูุฒูุน ุงูุฃุฏูุงุฑ
  socket.on('assign-roles', (data) => {
    const { roomCode, roles } = data;
    const room = rooms.get(roomCode);
    
    if (!room) {
      socket.emit('roles-error', 'ุงูุบุฑูุฉ ุบูุฑ ููุฌูุฏุฉ');
      return;
    }

    try {
      // ุชุทุจูู ุชูุฒูุน ุงูุฃุฏูุงุฑ
      const shuffledPlayers = [...room.players].sort(() => Math.random() - 0.5);
      
      shuffledPlayers.forEach((player, index) => {
        if (index < roles.length) {
          player.role = roles[index];
        }
      });

      room.rolesAssigned = true;
      
      // ุฅุฑุณุงู ุงูุชุญุฏูุซ ููุฌููุน
      io.to(roomCode).emit('roles-assigned', room);
      io.to(roomCode).emit('notification', {
        type: 'success',
        message: 'ุชู ุชูุฒูุน ุงูุฃุฏูุงุฑ ุจูุฌุงุญ!'
      });

      console.log(`๐ญ ุชู ุชูุฒูุน ุงูุฃุฏูุงุฑ ูู ุบุฑูุฉ ${roomCode}`);

    } catch (error) {
      console.error('โ ุฎุทุฃ ูู ุชูุฒูุน ุงูุฃุฏูุงุฑ:', error);
      socket.emit('roles-error', 'ุญุฏุซ ุฎุทุฃ ูู ุชูุฒูุน ุงูุฃุฏูุงุฑ');
    }
  });

  // ุชุนููู ุงููุงุฆุฏ
  socket.on('assign-chef', (data) => {
    const { roomCode, playerId } = data;
    const room = rooms.get(roomCode);
    
    if (!room) {
      socket.emit('chef-error', 'ุงูุบุฑูุฉ ุบูุฑ ููุฌูุฏุฉ');
      return;
    }

    try {
      // ุฅูุบุงุก ุงููุงุฆุฏ ุงูุณุงุจู
      room.players.forEach(player => {
        if (player.role && player.role.id === 'chef') {
          player.role = null;
        }
      });

      // ุชุนููู ุงููุงุฆุฏ ุงูุฌุฏูุฏ
      const newChef = room.players.find(p => p.id === playerId);
      if (newChef) {
        newChef.role = {
          id: 'chef',
          name: 'ุดุงู ุงููุฑูุฉ',
          team: 'VILLAGE',
          color: '#FFD700',
          emoji: '๐',
          description: 'ูุงุฆุฏ ุงููุฑูุฉ'
        };
      }

      // ุฅุฑุณุงู ุงูุชุญุฏูุซ ููุฌููุน
      io.to(roomCode).emit('chef-assigned', room);
      io.to(roomCode).emit('notification', {
        type: 'info',
        message: `ุชู ุชุนููู ${newChef.name} ููุงุฆุฏ ุฌุฏูุฏ`
      });

    } catch (error) {
      console.error('โ ุฎุทุฃ ูู ุชุนููู ุงููุงุฆุฏ:', error);
      socket.emit('chef-error', 'ุญุฏุซ ุฎุทุฃ ูู ุชุนููู ุงููุงุฆุฏ');
    }
  });

  // ุฅุฑุณุงู ุฑุณุงูุฉ ุฏุฑุฏุดุฉ
  socket.on('send-message', (data) => {
    const { roomCode, playerName, message, type = 'chat' } = data;
    
    io.to(roomCode).emit('new-message', { 
      playerName, 
      message, 
      type,
      timestamp: new Date() 
    });
  });

  // ุจุฏุก ุงููุนุจุฉ
  socket.on('start-game', (roomCode) => {
    const room = rooms.get(roomCode);
    if (!room) return;

    room.gameState = 'playing';
    io.to(roomCode).emit('game-started', room);
    io.to(roomCode).emit('notification', {
      type: 'success',
      message: 'ุจุฏุฃุช ุงููุนุจุฉ!'
    });
  });

  // ูุบุงุฏุฑุฉ ุงูุบุฑูุฉ
  socket.on('leave-room', (data) => {
    const { roomCode, playerName } = data;
    const room = rooms.get(roomCode);
    
    if (room) {
      room.players = room.players.filter(p => p.name !== playerName);
      players.delete(socket.id);
      
      io.to(roomCode).emit('player-left', { 
        playerName, 
        playersCount: room.players.length 
      });
      io.to(roomCode).emit('room-updated', room);
      
      // ุฅุฐุง ูู ูุนุฏ ููุงู ูุงุนุจููุ ุงุญุฐู ุงูุบุฑูุฉ
      if (room.players.length === 0) {
        rooms.delete(roomCode);
        console.log(`๐๏ธ ุชู ุญุฐู ุงูุบุฑูุฉ ${roomCode} (ูุง ููุฌุฏ ูุงุนุจูู)`);
      }
    }

    socket.leave(roomCode);
    console.log(`๐ ${playerName} ุบุงุฏุฑ ุงูุบุฑูุฉ ${roomCode}`);
  });

  // ูุตู ุงููุงุนุจ
  socket.on('disconnect', () => {
    const playerData = players.get(socket.id);
    if (playerData) {
      const { roomCode, player } = playerData;
      const room = rooms.get(roomCode);
      
      if (room) {
        room.players = room.players.filter(p => p.id !== socket.id);
        players.delete(socket.id);
        
        io.to(roomCode).emit('player-left', { 
          playerName: player.name, 
          playersCount: room.players.length 
        });
        io.to(roomCode).emit('room-updated', room);
        
        if (room.players.length === 0) {
          rooms.delete(roomCode);
        }
      }
    }
    
    console.log('โ ูุงุนุจ ููุตูู:', socket.id);
  });
});

const PORT = process.env.PORT || 3000;
server.listen(PORT, () => {
  console.log(`๐ฏ ุงูุฎุงุฏู ุดุบุงู ุนูู ุงููููุฐ ${PORT}`);
  console.log(`๐ http://localhost:${PORT}`);
  console.log(`๐ ุฑุงุจุท ุงููุงุฌูุฉ: http://localhost:${PORT}/client`);
});
