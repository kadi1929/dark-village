const express = require('express');
const http = require('http');
const socketIo = require('socket.io');
const path = require('path');
const cors = require('cors');

const app = express();
const server = http.createServer(app);

// ุฅุนุฏุงุฏุงุช Socket.io ููุนูู ูุน GitHub Pages
const io = socketIo(server, {
  cors: {
    origin: ["https://kadi1929.github.io", "http://localhost:3000"],
    methods: ["GET", "POST"],
    credentials: true
  }
});

// Middleware
app.use(cors());
app.use(express.json());
app.use(express.static(path.join(__dirname, '../client')));

// ุชุฎุฒูู ุงูุจูุงูุงุช
const rooms = new Map();
const players = new Map();

// ๐ ุตูุญุฉ ุงูุงุฎุชุจุงุฑ
app.get('/test', (req, res) => {
  res.json({ 
    status: 'โ ุงูุฎุงุฏู ุดุบุงู ุนูู Render',
    message: 'ุฌุงูุฒ ููุงุชุตุงู',
    timestamp: new Date().toISOString(),
    rooms: rooms.size,
    players: players.size
  });
});

// ๐ ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ
app.get('/', (req, res) => {
  res.sendFile(path.join(__dirname, '../client/index.html'));
});

// ๐ ูุนูููุงุช ุงูุฎุงุฏู
app.get('/info', (req, res) => {
  res.json({
    server: 'Dark Village Server - Render',
    version: '2.0.0',
    uptime: process.uptime(),
    status: 'active'
  });
});

// ๐ ุฃุญุฏุงุซ Socket.io
io.on('connection', (socket) => {
  console.log('๐ ูุงุนุจ ูุชุตู:', socket.id);
  
  // ุฅุฑุณุงู ุชุฃููุฏ ุงูุงุชุตุงู
  socket.emit('connection-status', { 
    status: 'connected', 
    message: 'ูุฑุญุจุงู ูู ุงููุฑูุฉ ุงููุธููุฉ!',
    socketId: socket.id
  });

  // ๐ ุฅูุดุงุก ุบุฑูุฉ ุฌุฏูุฏุฉ
  socket.on('create-room', (data) => {
    console.log('๐ฎ ุทูุจ ุฅูุดุงุก ุบุฑูุฉ:', data);
    
    try {
      const { roomCode, roomName, playerName } = data;
      
      // ุงูุชุญูู ูู ุงูุจูุงูุงุช
      if (!roomCode || !roomName || !playerName) {
        socket.emit('create-error', 'โ ุฌููุน ุงูุญููู ูุทููุจุฉ');
        return;
      }

      // ุงูุชุญูู ูู ูุฌูุฏ ุงูุบุฑูุฉ
      if (rooms.has(roomCode)) {
        socket.emit('create-error', 'โ ุฑูู ุงูุบุฑูุฉ ููุฌูุฏ ูุณุจูุงู');
        return;
      }

      // ุฅูุดุงุก ุบุฑูุฉ ุฌุฏูุฏุฉ
      const room = {
        name: roomName,
        code: roomCode,
        players: [],
        maxPlayers: 10,
        gameState: 'waiting',
        createdAt: new Date(),
        createdBy: playerName
      };

      rooms.set(roomCode, room);
      
      // ุฅุฑุณุงู ูุฌุงุญ ุงูุฅูุดุงุก
      socket.emit('room-created', { 
        roomCode: roomCode,
        roomName: roomName,
        message: '๐ ุชู ุฅูุดุงุก ุงูุบุฑูุฉ ุจูุฌุงุญ!'
      });

      console.log(`โ ุชู ุฅูุดุงุก ุบุฑูุฉ: ${roomName} (${roomCode})`);
      
    } catch (error) {
      console.error('โ ุฎุทุฃ ูู ุฅูุดุงุก ุงูุบุฑูุฉ:', error);
      socket.emit('create-error', 'ุญุฏุซ ุฎุทุฃ ุบูุฑ ูุชููุน');
    }
  });

  // ๐ ุงูุงูุถูุงู ุฅูู ุบุฑูุฉ
  socket.on('join-room', (data) => {
    console.log('๐ ุทูุจ ุงูุถูุงู:', data);
    
    try {
      const { roomCode, playerName, isGameMaster } = data;
      
      if (!roomCode || !playerName) {
        socket.emit('join-error', 'โ ุฑูู ุงูุบุฑูุฉ ูุงุณู ุงููุงุนุจ ูุทููุจุงู');
        return;
      }

      // ุงูุจุญุซ ุนู ุงูุบุฑูุฉ
      const room = rooms.get(roomCode);
      if (!room) {
        socket.emit('join-error', 'โ ุงูุบุฑูุฉ ุบูุฑ ููุฌูุฏุฉ');
        return;
      }

      // ุงูุชุญูู ูู ุนุฏุฏ ุงููุงุนุจูู
      if (room.players.length >= room.maxPlayers) {
        socket.emit('join-error', 'โ ุงูุบุฑูุฉ ููุชูุฆุฉ');
        return;
      }

      // ุงูุชุญูู ูู ุนุฏู ุชูุฑุงุฑ ุงูุงุณู
      const existingPlayer = room.players.find(p => p.name === playerName);
      if (existingPlayer) {
        socket.emit('join-error', 'โ ุงุณู ุงููุงุนุจ ููุฌูุฏ ูุณุจูุงู');
        return;
      }

      // ุฅูุดุงุก ูุงุนุจ ุฌุฏูุฏ
      const player = {
        id: socket.id,
        name: playerName,
        isGameMaster: isGameMaster || false,
        role: null,
        isAlive: true,
        socketId: socket.id,
        joinedAt: new Date()
      };

      // ุฅุถุงูุฉ ุงููุงุนุจ ููุบุฑูุฉ
      room.players.push(player);
      players.set(socket.id, { roomCode, player });

      // ุงูุถูุงู Socket ููุบุฑูุฉ
      socket.join(roomCode);
      
      // ุฅุฑุณุงู ุชุญุฏูุซ ููุฌููุน
      io.to(roomCode).emit('room-updated', room);
      io.to(roomCode).emit('player-joined', { 
        playerName, 
        playersCount: room.players.length 
      });

      // ุฅุฑุณุงู ูุฌุงุญ ุงูุงุชุตุงู ููุงุนุจ ุงูุฌุฏูุฏ
      socket.emit('join-success', room);

      console.log(`โ ${playerName} ุงูุถู ุฅูู ุบุฑูุฉ ${roomCode}`);

    } catch (error) {
      console.error('โ ุฎุทุฃ ูู ุงูุงูุถูุงู:', error);
      socket.emit('join-error', 'ุญุฏุซ ุฎุทุฃ ูู ุงูุงูุถูุงู');
    }
  });

  // ๐ญ ุชูุฒูุน ุงูุฃุฏูุงุฑ
  socket.on('assign-roles', (data) => {
    console.log('๐ญ ุชูุฒูุน ุงูุฃุฏูุงุฑ:', data);
    
    try {
      const { roomCode } = data;
      const room = rooms.get(roomCode);
      
      if (!room) {
        socket.emit('roles-error', 'โ ุงูุบุฑูุฉ ุบูุฑ ููุฌูุฏุฉ');
        return;
      }

      // ุชุนุฑูู ุงูุฃุฏูุงุฑ
      const availableRoles = [
        { id: 'werewolf_alpha', name: 'ุงูุฐุฆุจ ุฃููุง', emoji: '๐ค', color: '#000000' },
        { id: 'seer', name: 'ุงูุนุฑุงูุฉ', emoji: '๐ฎ', color: '#FFFFFF' },
        { id: 'witch', name: 'ุงูุณุงุญุฑุฉ', emoji: '๐งช', color: '#8A2BE2' },
        { id: 'guardian', name: 'ุงูุถุงูู', emoji: '๐', color: '#1E90FF' },
        { id: 'hunter', name: 'ุงูุตูุงุฏ', emoji: '๐', color: '#32CD32' },
        { id: 'chef', name: 'ุงููุงุฆุฏ', emoji: '๐', color: '#FFD700' },
        { id: 'villager', name: 'ูุฑูู', emoji: '๐จโ๐พ', color: '#FFFFFF' }
      ];

      // ุชูุฒูุน ุนุดูุงุฆู ููุฃุฏูุงุฑ
      const shuffledPlayers = [...room.players].sort(() => Math.random() - 0.5);
      const shuffledRoles = [...availableRoles].sort(() => Math.random() - 0.5);

      shuffledPlayers.forEach((player, index) => {
        if (index < shuffledRoles.length) {
          player.role = shuffledRoles[index];
        }
      });

      room.rolesAssigned = true;
      
      // ุฅุฑุณุงู ุงูุชุญุฏูุซ ููุฌููุน
      io.to(roomCode).emit('roles-assigned', room);
      io.to(roomCode).emit('notification', {
        type: 'success',
        message: '๐ญ ุชู ุชูุฒูุน ุงูุฃุฏูุงุฑ ุจูุฌุงุญ!'
      });

      console.log(`โ ุชู ุชูุฒูุน ุงูุฃุฏูุงุฑ ูู ุบุฑูุฉ ${roomCode}`);

    } catch (error) {
      console.error('โ ุฎุทุฃ ูู ุชูุฒูุน ุงูุฃุฏูุงุฑ:', error);
      socket.emit('roles-error', 'ุญุฏุซ ุฎุทุฃ ูู ุชูุฒูุน ุงูุฃุฏูุงุฑ');
    }
  });

  // ๐ ุชุนููู ุงููุงุฆุฏ
  socket.on('assign-chef', (data) => {
    const { roomCode, playerId } = data;
    const room = rooms.get(roomCode);
    
    if (!room) {
      socket.emit('chef-error', 'โ ุงูุบุฑูุฉ ุบูุฑ ููุฌูุฏุฉ');
      return;
    }

    try {
      // ุฅูุบุงุก ุงููุงุฆุฏ ุงูุณุงุจู
      room.players.forEach(player => {
        if (player.role && player.role.id === 'chef') {
          player.role = { id: 'villager', name: 'ูุฑูู', emoji: '๐จโ๐พ', color: '#FFFFFF' };
        }
      });

      // ุชุนููู ุงููุงุฆุฏ ุงูุฌุฏูุฏ
      const newChef = room.players.find(p => p.id === playerId);
      if (newChef) {
        newChef.role = { id: 'chef', name: 'ุงููุงุฆุฏ', emoji: '๐', color: '#FFD700' };
      }

      // ุฅุฑุณุงู ุงูุชุญุฏูุซ ููุฌููุน
      io.to(roomCode).emit('chef-assigned', room);
      io.to(roomCode).emit('notification', {
        type: 'info',
        message: `๐ ุชู ุชุนููู ${newChef.name} ููุงุฆุฏ ุฌุฏูุฏ`
      });

    } catch (error) {
      console.error('โ ุฎุทุฃ ูู ุชุนููู ุงููุงุฆุฏ:', error);
      socket.emit('chef-error', 'ุญุฏุซ ุฎุทุฃ ูู ุชุนููู ุงููุงุฆุฏ');
    }
  });

  // ๐ฎ ุจุฏุก ุงููุนุจุฉ
  socket.on('start-game', (roomCode) => {
    const room = rooms.get(roomCode);
    if (!room) return;

    room.gameState = 'playing';
    io.to(roomCode).emit('game-started', room);
    io.to(roomCode).emit('notification', {
      type: 'success',
      message: '๐ฎ ุจุฏุฃุช ุงููุนุจุฉ! ุงุณุชุนุฏูุง...'
    });
  });

  // ๐ข ุฅุฑุณุงู ุฑุณุงูุฉ
  socket.on('send-message', (data) => {
    const { roomCode, playerName, message } = data;
    io.to(roomCode).emit('new-message', {
      playerName,
      message,
      timestamp: new Date()
    });
  });

  // ๐ช ูุบุงุฏุฑุฉ ุงูุบุฑูุฉ
  socket.on('leave-room', (data) => {
    const { roomCode, playerName } = data;
    const room = rooms.get(roomCode);
    
    if (room) {
      room.players = room.players.filter(p => p.name !== playerName);
      players.delete(socket.id);
      
      io.to(roomCode).emit('player-left', { 
        playerName, 
        playersCount: room.players.length 
      });
      io.to(roomCode).emit('room-updated', room);
      
      // ุฅุฐุง ูู ูุนุฏ ููุงู ูุงุนุจููุ ุงุญุฐู ุงูุบุฑูุฉ
      if (room.players.length === 0) {
        rooms.delete(roomCode);
        console.log(`๐๏ธ ุชู ุญุฐู ุงูุบุฑูุฉ ${roomCode} (ูุง ููุฌุฏ ูุงุนุจูู)`);
      }
    }

    socket.leave(roomCode);
    console.log(`๐ ${playerName} ุบุงุฏุฑ ุงูุบุฑูุฉ ${roomCode}`);
  });

  // โ ูุตู ุงูุงุชุตุงู
  socket.on('disconnect', () => {
    console.log('โ ูุงุนุจ ููุตูู:', socket.id);
    
    const playerData = players.get(socket.id);
    if (playerData) {
      const { roomCode, player } = playerData;
      const room = rooms.get(roomCode);
      
      if (room) {
        room.players = room.players.filter(p => p.id !== socket.id);
        players.delete(socket.id);
        
        io.to(roomCode).emit('player-left', { 
          playerName: player.name, 
          playersCount: room.players.length 
        });
        io.to(roomCode).emit('room-updated', room);
        
        if (room.players.length === 0) {
          rooms.delete(roomCode);
        }
      }
    }
  });
});

// ๐ ุชุดุบูู ุงูุฎุงุฏู
const PORT = process.env.PORT || 3000;
server.listen(PORT, '0.0.0.0', () => {
  console.log('๐ ==================================');
  console.log('๐ฏ ุฎุงุฏู ุงููุฑูุฉ ุงููุธููุฉ ุดุบุงู!');
  console.log(`๐ http://localhost:${PORT}`);
  console.log(`๐ https://kadi1929.github.io/dark-village`);
  console.log('๐ ุฌุงูุฒ ููุงุชุตุงู ูู GitHub Pages');
  console.log('๐ ==================================');
});
